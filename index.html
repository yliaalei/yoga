<!doctype html>


function loadFromLocal(){
const raw = localStorage.getItem(DATA_KEY);
if(!raw) return false;
try{
const data = JSON.parse(raw);
document.querySelectorAll('.date-header').forEach((inp,i)=>{ inp.value = data.headers[i] || ''; });
data.rows.forEach((rowObj, idx)=>{
const r = 2+idx;
const nameInput = document.querySelector(`input.name-input[data-row='${r}']`);
if(nameInput) nameInput.value = rowObj.name || '';
for(let c=2;c<=9;c++){
const cb = document.querySelector(`input[type=checkbox][data-row='${r}'][data-col='${c}']`);
if(cb) cb.checked = !!rowObj.checks[c-2];
}
});
updateAllResults();
return true;
}catch(e){console.error(e);return false}
}


function clearAll(confirmNeeded=true){
if(confirmNeeded && !confirm('Сбросить таблицу? Данные в localStorage будут удалены.')) return;
document.querySelectorAll('.date-header').forEach(inp=>inp.value='');
document.querySelectorAll('input.name-input').forEach(inp=>inp.value='');
document.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
updateAllResults();
localStorage.removeItem(DATA_KEY);
flashMessage('Сброшено');
}


function flashMessage(text){
const el = document.createElement('div');
el.textContent = text;
Object.assign(el.style,{position:'fixed',right:'20px',bottom:'20px',background:'#111',color:'#fff',padding:'8px 12px',borderRadius:'8px',opacity:'0',transition:'all 200ms'});
document.body.appendChild(el);
requestAnimationFrame(()=>el.style.opacity='1');
setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),300); },1000);
}


function exportJSON(){
const data = collectData();
const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url; a.download = 'yoga-journal.json';
document.body.appendChild(a); a.click(); a.remove();
URL.revokeObjectURL(url);
}


function importJSON(file){
const reader = new FileReader();
reader.onload = ()=>{
try{
const data = JSON.parse(reader.result);
if(!data.rows || !Array.isArray(data.rows)) throw new Error('Неверный формат');
localStorage.setItem(DATA_KEY, JSON.stringify(data));
loadFromLocal();
flashMessage('Импортировано');
}catch(e){ alert('Ошибка при импорте: '+e.message); }
};
reader.readAsText(file);
}


function attachEvents(){
document.addEventListener('input', (e)=>{
if(e.target.matches('.date-header') || e.target.matches('.name-input')){
updateAllResults();
saveToLocal();
}
});
document.addEventListener('change', (e)=>{
if(e.target.matches('input[type=checkbox]')){
updateAllResults();
saveToLocal();
}
});
document.getElementById('saveBtn').addEventListener('click', saveToLocal);
document.getElementById('clearBtn').addEventListener('click', ()=>clearAll(true));
document.getElementById('exportBtn').addEventListener('click', exportJSON);
document.getElementById('importBtn').addEventListener('click', ()=>document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change', (ev)=>{
const f = ev.target.files[0];
if(f) importJSON(f);
ev.target.value = '';
});
}


createTableRows();
attachEvents();
if(!loadFromLocal()){
updateAllResults();
}
</script>
</body>
</html>
